<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Analytics Dashboard</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f5f5f5;
}

h1 {
    text-align: center;
}

.filter-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

select, input, button {
    padding: 8px 12px;
    font-size: 15px;
}

button {
    cursor: pointer;
}

.results, .profile {
    margin-top: 25px;
}

.card {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

th, td {
    border: 1px solid #ddd;
    padding: 8px;
}

th {
    background-color: #f0f0f0;
}

.autocomplete-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    max-height: 160px;
    overflow-y: auto;
    width: 260px;
    z-index: 1000;
}

.autocomplete-suggestion {
    padding: 6px 10px;
    cursor: pointer;
}

.autocomplete-suggestion:hover {
    background-color: #eee;
}
</style>
</head>

<body>

<h1>Research Analytics Dashboard</h1>

<!-- ================= FILTERS ================= -->
<div class="filter-container">

    <select id="country-select">
        <option value="">Select Country</option>
    </select>

    <div style="position:relative">
        <input type="text" id="institution-input" placeholder="Type institution">
        <div id="institution-suggestions" class="autocomplete-suggestions"></div>
    </div>

    <input type="text" id="field-input" placeholder="Research field">

    <div style="position:relative">
        <input type="text" id="researcher-input" placeholder="Search researcher">
        <div id="researcher-suggestions" class="autocomplete-suggestions"></div>
    </div>

    <button id="filter-btn">Apply Filters</button>

</div>

<!-- ================= RESEARCHER PROFILE ================= -->
<div id="researcher-profile" class="profile"></div>

<!-- ================= ANALYTICS RESULTS ================= -->
<div id="results" class="results"></div>

<script>
const API = "http://127.0.0.1:5000";

const countrySelect = document.getElementById("country-select");
const institutionInput = document.getElementById("institution-input");
const institutionSuggestions = document.getElementById("institution-suggestions");

const researcherInput = document.getElementById("researcher-input");
const researcherSuggestions = document.getElementById("researcher-suggestions");
const researcherProfile = document.getElementById("researcher-profile");

const fieldInput = document.getElementById("field-input");
const filterBtn = document.getElementById("filter-btn");
const resultsDiv = document.getElementById("results");

let institutions = [];

/* ================= LOAD COUNTRIES ================= */
async function loadCountries() {
    const res = await fetch(`${API}/api/countries`);
    const data = await res.json();
    data.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        countrySelect.appendChild(opt);
    });
}

/* ================= LOAD INSTITUTIONS ================= */
async function loadInstitutions() {
    const res = await fetch(`${API}/api/institutions`);
    institutions = await res.json();
}

/* ================= INSTITUTION AUTOCOMPLETE ================= */
institutionInput.addEventListener("input", () => {
    const q = institutionInput.value.toLowerCase();
    institutionSuggestions.innerHTML = "";
    if (!q) return;

    institutions
        .filter(i => i.name.toLowerCase().includes(q))
        .forEach(i => {
            const div = document.createElement("div");
            div.className = "autocomplete-suggestion";
            div.textContent = i.name;
            div.onclick = () => {
                institutionInput.value = i.name;
                institutionInput.dataset.id = i.id;
                institutionSuggestions.innerHTML = "";
            };
            institutionSuggestions.appendChild(div);
        });
});

/* ================= RESEARCHER AUTOCOMPLETE ================= */
researcherInput.addEventListener("input", async () => {
    const q = researcherInput.value.trim();
    researcherSuggestions.innerHTML = "";
    researcherProfile.innerHTML = "";
    if (!q) return;

    const params = new URLSearchParams({ q });

    if (countrySelect.value)
        params.append("country_id", countrySelect.value);

    if (institutionInput.dataset.id)
        params.append("institution_id", institutionInput.dataset.id);

    const res = await fetch(`${API}/api/researchers/search?${params}`);
    const researchers = await res.json();

    researchers.forEach(r => {
        const div = document.createElement("div");
        div.className = "autocomplete-suggestion";
        div.textContent = r.full_name;
        div.onclick = () => loadResearcherProfile(r.id);
        researcherSuggestions.appendChild(div);
    });
});

/* ================= LOAD RESEARCHER PROFILE ================= */
async function loadResearcherProfile(id) {
    researcherSuggestions.innerHTML = "";

    const res = await fetch(`${API}/api/researchers/${id}`);
    const r = await res.json();

    researcherProfile.innerHTML = `
        <div class="card">
            <h2>${r.full_name}</h2>
            <p><strong>H-index:</strong> ${r.h_index}</p>
            <p><strong>RII:</strong> ${r.rii}</p>
            <p><strong>Total Citations:</strong> ${r.total_citations}</p>
            <p><strong>Total Publications:</strong> ${r.total_publications}</p>
        </div>
    `;
}

/* ================= FETCH ANALYTICS ================= */
async function fetchAnalytics() {
    const params = new URLSearchParams();

    if (countrySelect.value)
        params.append("country_id", countrySelect.value);

    if (institutionInput.dataset.id)
        params.append("institution_id", institutionInput.dataset.id);

    if (fieldInput.value)
        params.append("field", fieldInput.value);

    const res = await fetch(`${API}/analytics?${params}`);
    const data = await res.json();
    displayAnalytics(data);
}

/* ================= DISPLAY ANALYTICS ================= */
function displayAnalytics(data) {
    resultsDiv.innerHTML = `
        <div class="card">
            <h2>Metrics</h2>
            <p>Average H-index: ${data.metrics.average_h_index}</p>
            <p>Average RII: ${data.metrics.average_rii}</p>
        </div>

        <div class="card">
            <h2>Top Researchers (H-index)</h2>
            ${makeTable(data.top_researchers.by_h_index, ["name","h_index","rii","total_publications","total_citations"])}
        </div>

        <div class="card">
            <h2>Top Researchers (RII)</h2>
            ${makeTable(data.top_researchers.by_rii, ["name","h_index","rii","total_publications","total_citations"])}
        </div>
    `;
}

/* ================= TABLE HELPER ================= */
function makeTable(items, cols) {
    let html = "<table><thead><tr>";
    cols.forEach(c => html += `<th>${c.replace("_"," ").toUpperCase()}</th>`);
    html += "</tr></thead><tbody>";

    items.forEach(i => {
        html += "<tr>";
        cols.forEach(c => html += `<td>${i[c] ?? ""}</td>`);
        html += "</tr>";
    });

    html += "</tbody></table>";
    return html;
}

/* ================= EVENTS ================= */
filterBtn.addEventListener("click", fetchAnalytics);

/* ================= INIT ================= */
loadCountries();
loadInstitutions();
</script>

</body>
</html>
